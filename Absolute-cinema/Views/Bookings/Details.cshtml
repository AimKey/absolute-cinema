@model Common.ViewModels.BookingVMs.ReviewBookingVM
@{
    ViewData["Title"] = "Review Reservation";
    var showtime = Model.Showtime;
    var user = Model.UserInfo;
    var tickets = Model.Tickets;
    var seats = Model.BookedSeat;
    var total = Model.TotalBookingCost;
}

<div class="container mx-auto py-10">
    <!-- Countdown Timer -->
    <div class="flex justify-center mb-6">
        <div class="bg-red-700 text-white px-6 py-3 rounded-full shadow text-xl font-bold flex items-center gap-2">
            <span class="mr-2">Time left to complete payment:</span>
            <span id="countdownTimer" class="font-mono">05:00</span>
        </div>
    </div>
    <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 max-w-3xl mx-auto">
        <h1 class="text-3xl font-bold text-white mb-6 text-center">Review Your Reservation</h1>
        <!-- Showtime & User Info -->
        <div class="flex flex-col md:flex-row md:justify-between gap-6 mb-8">
            <div class="flex-1">
                <h2 class="text-xl font-semibold text-gray-200 mb-2">Showtime Information</h2>
                <div class="text-gray-300">
                    <div><span class="font-semibold">Movie:</span> @showtime.Movie?.Title</div>
                    <div><span class="font-semibold">Room:</span> @showtime.Room?.Name</div>
                    <div><span class="font-semibold">Date:</span> @showtime.StartTime.ToString("dd/MM/yyyy")</div>
                    <div><span class="font-semibold">Time:</span> @showtime.StartTime.ToString("HH:mm")</div>
                </div>
            </div>
            <div class="flex-1">
                <h2 class="text-xl font-semibold text-gray-200 mb-2">Your Information</h2>
                <div class="text-gray-300">
                    <div><span class="font-semibold">Name:</span> @user?.UserDetail?.FullName</div>
                    <div><span class="font-semibold">Email:</span> @user?.Email</div>
                    <div><span class="font-semibold">Phone:</span> @user?.UserDetail?.Phone</div>
                </div>
            </div>
        </div>
        <!-- Ticket Table -->
        <div class="bg-gray-900 rounded-xl shadow p-6 mb-8">
            <h2 class="text-lg font-semibold text-white mb-4">Your Tickets</h2>
            <table class="w-full text-gray-200 text-sm">
                <thead>
                    <tr class="border-b border-gray-700">
                        <th class="py-2 text-left">#</th>
                        <th class="py-2 text-left">Seat</th>
                        <th class="py-2 text-left">Type</th>
                        <th class="py-2 text-right">Price</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < tickets.Count; i++)
                    {
                        var ticket = tickets[i];
                        var seat = seats.FirstOrDefault(s => s.Id == ticket.ShowtimeSeat?.SeatId);
                        var seatType = seat?.SeatType?.Name ?? "Standard";
                        <tr class="border-b border-gray-800 hover:bg-gray-800/60">
                            <td class="py-2">@(i + 1)</td>
                            <td class="py-2">@seat?.SeatRow@seat?.SeatNumber</td>
                            <td class="py-2">@seatType</td>
                            <td class="py-2 text-right">@ticket.Price.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN")) ₫</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <!-- Total & Continue Button -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mt-6">
            <div class="text-xl font-bold text-white">
                Total: <span class="text-green-400">@total.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN")) ₫</span>
            </div>
            <form asp-action="Payment" asp-controller="Bookings" method="post">
                <input type="hidden" name="bookingId" value="@Model.BookingId" />
                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full shadow transition-all duration-200 text-lg">
                    Continue to Payment
                </button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 5 minute countdown
        let countdown = 5 * 60; // seconds
        const timerDisplay = document.getElementById('countdownTimer');
        let timerInterval = setInterval(function() {
            const min = Math.floor(countdown / 60).toString().padStart(2, '0');
            const sec = (countdown % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${min}:${sec}`;
            if (countdown <= 0) {
                clearInterval(timerInterval);
                alert('Your time to complete payment has ended. You will be redirected to the home page.');
                window.location.href = '/';
            }
            countdown--;
        }, 1000);

        // Warn user if they try to close or reload the page
        window.onbeforeunload = function (e) {
            e = e || window.event;
            // For modern browsers
            if (e) {
                e.returnValue = 'If you leave, your booking will be canceled.';
            }
            // For old browsers
            return 'If you leave, your booking will be canceled.';
        };
    </script>
}

